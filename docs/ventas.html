<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ventas por d√≠a</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;max-width:1000px}
  h1{margin:0 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
  label{display:block;margin:12px 0 6px}
  input,button{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:8px}
  button.primary{background:#111;color:#fff;border-color:#111}
  .muted{color:#666;font-size:12px}
  .section{margin-top:20px}
  .sec-title{font-size:18px;margin:10px 0}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #ddd;padding:6px;text-align:left}
  th{background:#f7f7f7}
  .right{text-align:right}
  .tot{background:#fafafa;font-weight:600}
  .inline{display:inline-block;margin-right:8px}
  .warn{background:#fff3cd;border:1px solid #ffeeba;border-radius:8px;padding:8px}
  /* filtro m√©todo de pago */
  .pay-wrap{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0}
  .pill{border:1px solid #ccc;border-radius:999px;padding:8px 14px;background:#f5f5f5;cursor:pointer;user-select:none}
  .pill.active{outline:2px solid #000;background:#fff}
  @media print{
    .no-print{display:none}
    body{margin:0.5cm}
  }
</style>
</head>
<body>
<h1>Ventas por d√≠a</h1>
<p class="muted">Elige una fecha para ver el detalle. Se agrupa por secciones (categor√≠as). Ahora puedes filtrar por m√©todo de pago.</p>

<div class="row no-print">
  <div>
    <label for="fecha">Fecha</label>
    <input id="fecha" type="date">
  </div>
  <div>
    <button id="cargar" class="primary">Cargar</button>
  </div>
  <div>
    <button id="imprimir">Imprimir</button>
  </div>
</div>

<!-- Filtro de m√©todo de pago -->
<div class="pay-wrap no-print">
  <strong>M√©todo de pago:</strong>
  <span id="payTodos"  class="pill active" data-metodo="todos">Todos</span>
  <span id="payEfe"    class="pill"        data-metodo="efectivo">Efectivo</span>
  <span id="payTarj"   class="pill"        data-metodo="tarjeta">Tarjeta</span>
</div>

<div id="msg" class="muted"></div>

<div id="resumen" class="section"></div>
<div id="contenedor"></div>

<script>
// ---------- Config del repo ----------
const ORG  = "OswaldoCasillas";
const REPO = "Ventas";

// ---------- Categor√≠as (mismo mapping que en register/produccion) ----------
const CAT_LABELS = {
  "PALETA-AGUA": "Paleta de Agua",
  "PALETA-AGUA-PREMIUM": "Paleta Agua Premium",
  "PALETA-CREMA": "Paleta de Crema",
  "PALETA-CREMA-PREMIUM": "Paleta Crema Premium",
  "PALETA-SIN-AZUCAR": "Paleta Sin Az√∫car/Keto",
  "PALETA-MINI": "Paleta Mini",
  "PALETAS-PERRO": "Paletas para Perro", // üëà agregado
  "HELADO-NIEVE": "Helado Nieve",
  "HELADO-CLASICO": "Helado Cl√°sico",
  "HELADO-GOURMET": "Helado Gourmet",
  "HELADO-SIN-AZUCAR": "Helado Sin Az√∫car",
  "MALTEADA": "Malteada",
  "AGUA-FRESCA": "Aguas Frescas",
  "BEBIDA": "Bebidas",
  "POSTRE": "Postres",
  "BOTANA": "Botanas",
  "EXTRA": "Extras"
};
const SECTION_ORDER = [
  "PALETA-AGUA","PALETA-AGUA-PREMIUM","PALETA-CREMA","PALETA-CREMA-PREMIUM","PALETA-SIN-AZUCAR","PALETA-MINI",
  "PALETAS-PERRO",
  "HELADO-NIEVE","HELADO-CLASICO","HELADO-GOURMET","HELADO-SIN-AZUCAR",
  "MALTEADA","AGUA-FRESCA","BEBIDA","POSTRE","BOTANA","EXTRA","OTROS"
];

let _rowsFull = []; // sin filtrar
let _fechaActual = ""; 
let _metodo = "todos"; // todos | efectivo | tarjeta

function setMetodo(m){
  _metodo = m;
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  (m==='efectivo' ? document.getElementById('payEfe')
   : m==='tarjeta' ? document.getElementById('payTarj')
   : document.getElementById('payTodos')
  ).classList.add('active');

  // Vuelve a renderizar con el filtro
  const filtradas = (_metodo==='todos')
    ? _rowsFull.slice()
    : _rowsFull.filter(r => (r.metodo_pago||'efectivo').toLowerCase() === _metodo);
  render(filtradas, _fechaActual, _rowsFull);
}

function getCategoryOf(sku){
  const keys = Object.keys(CAT_LABELS).sort((a,b)=>b.length-a.length);
  for(const k of keys){ if(sku.startsWith(k)) return k; }
  return "OTROS";
}
function skuToNice(sku){
  const prefixes = [
    "PALETA-AGUA-PREMIUM","PALETA-CREMA-PREMIUM","PALETA-SIN-AZUCAR",
    "PALETA-AGUA","PALETA-CREMA","PALETA-MINI",
    "HELADO-NIEVE","HELADO-CLASICO","HELADO-GOURMET","HELADO-SIN-AZUCAR",
    "AGUA-FRESCA","MALTEADA","BEBIDA","POSTRE","BOTANA","EXTRA","PALETAS-PERRO"
  ];
  let name = sku;
  for(const p of prefixes){
    if(name.startsWith(p+"-")) { name = name.slice(p.length+1); break; }
  }
  name = name.replace(/-/g," ").toLowerCase()
             .replace(/\b\w/g, c=>c.toUpperCase())
             .replace(/\bS\/?Azucar\b/gi,'Sin Az√∫car');
  return name.trim();
}
function fmtMx(n){ return Number(n||0).toLocaleString('es-MX',{style:'currency',currency:'MXN'}); }

// ---------- CSV parser peque√±ito ----------
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(",").map(h=>h.trim());
  return lines.map(line=>{
    const parts = []; // soporta comas simples (sin comillas escapadas complejas)
    let current = "", inQuotes = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"' ){ inQuotes = !inQuotes; continue; }
      if(ch === "," && !inQuotes){ parts.push(current); current=""; continue; }
      current += ch;
    }
    parts.push(current);
    const obj = {};
    headers.forEach((h,i)=>obj[h]= (parts[i]||"").trim());
    return obj;
  });
}

// ---------- Carga datos para una fecha ----------
async function loadForDate(fecha){
  const msg = document.getElementById('msg');
  msg.textContent = "Cargando‚Ä¶";
  _fechaActual = fecha;

  // Preferimos el archivo diario si existe
  const dailyUrl = `diario/${fecha}-ventas.csv?_=${Date.now()}`;
  let rows = null;
  try{
    const r = await fetch(dailyUrl);
    if(r.ok){
      rows = parseCSV(await r.text());
    }
  }catch(e){/* ignora */ }
  if(!rows){
    // Fallback: ventas_detalle.csv y filtramos por fecha
    const r2 = await fetch(`ventas_detalle.csv?_=${Date.now()}`);
    if(!r2.ok){
      msg.innerHTML = `<div class="warn">No encontr√© ventas para esa fecha ni el detalle general. ¬øYa corri√≥ el workflow despu√©s de registrar ventas?</div>`;
      render([], fecha, []);
      return;
    }
    const all = parseCSV(await r2.text());
    rows = all.filter(x=>x.fecha===fecha);
  }

  // normaliza num√©ricos y m√©todo
  rows.forEach(r=>{
    r.cantidad = Number(r.cantidad||0);
    r.precio_unit = Number(r.precio_unit||0);
    r.importe = Number(r.importe|| (r.cantidad*r.precio_unit));
    r.metodo_pago = (r.metodo_pago || "efectivo").toLowerCase();
  });

  _rowsFull = rows.slice(); // guardamos SIN filtrar
  setMetodo(_metodo);       // fuerza primera render con el filtro actual
  msg.textContent = "";
}

// ---------- Render ----------
function render(rows, fecha, allRows){
  const cont = document.getElementById('contenedor');
  const res  = document.getElementById('resumen');
  cont.innerHTML = ""; res.innerHTML = "";

  if(!rows || rows.length===0){
    cont.innerHTML = `<div class="warn">No hay ventas registradas el ${fecha}${_metodo!=='todos' ? ` (filtro: ${_metodo})` : ''}.</div>`;
    return;
  }

  // Agrupa por secci√≥n -> item
  const bySec = {};
  for(const r of rows){
    const sec = getCategoryOf(r.item);
    if(!bySec[sec]) bySec[sec] = {};
    const key = r.item;
    if(!bySec[sec][key]) bySec[sec][key] = { sku:r.item, nombre: r.descripcion || skuToNice(r.item), cantidad:0, importe:0, precio:r.precio_unit };
    bySec[sec][key].cantidad += r.cantidad;
    bySec[sec][key].importe  += r.importe;
    if(!bySec[sec][key].precio && r.precio_unit) bySec[sec][key].precio = r.precio_unit;
  }

  // Totales (con filtro aplicado)
  let granTotal = 0, granUnidades = 0;
  const sections = Object.keys(bySec).sort((a,b)=>SECTION_ORDER.indexOf(a)-SECTION_ORDER.indexOf(b));
  for(const sec of sections){
    const items = Object.values(bySec[sec]).sort((a,b)=>b.cantidad-a.cantidad || a.nombre.localeCompare(b.nombre,'es'));
    const totalSec = items.reduce((s,x)=>s+x.importe,0);
    const udsSec   = items.reduce((s,x)=>s+x.cantidad,0);
    granTotal += totalSec; granUnidades += udsSec;

    const html = `
      <div class="section">
        <div class="sec-title">${CAT_LABELS[sec]||sec} ‚Äî <span class="muted">${udsSec} u ‚Ä¢ ${fmtMx(totalSec)}</span></div>
        <table>
          <thead><tr><th>Producto</th><th>SKU</th><th class="right">Cantidad</th><th class="right">Precio</th><th class="right">Importe</th></tr></thead>
          <tbody>
            ${items.map(x=>`<tr>
              <td>${x.nombre}</td>
              <td>${x.sku}</td>
              <td class="right">${x.cantidad}</td>
              <td class="right">${x.precio?fmtMx(x.precio):""}</td>
              <td class="right">${fmtMx(x.importe)}</td>
            </tr>`).join("")}
          </tbody>
          <tfoot><tr><th colspan="4" class="right tot">Total secci√≥n</th><th class="right tot">${fmtMx(totalSec)}</th></tr></tfoot>
        </table>
      </div>`;
    cont.insertAdjacentHTML('beforeend', html);
  }

  // Resumen por m√©todo (siempre basado en allRows = sin filtrar)
  const sumAll = (list, m)=> list.filter(r=>m==='todos' ? true : (r.metodo_pago||'efectivo')===m)
                                 .reduce((acc,r)=>{acc.u+=r.cantidad; acc.$+=r.importe; return acc;},{u:0,$:0});
  const totTodos   = sumAll(allRows, 'todos');
  const totEfe     = sumAll(allRows, 'efectivo');
  const totTarj    = sumAll(allRows, 'tarjeta');

  res.innerHTML = `
    <div class="section">
      <h2>Resumen del d√≠a ${fecha}${_metodo!=='todos' ? ` ‚Äî <span class="muted">Filtro: ${_metodo}</span>` : ''}</h2>
      <table>
        <tbody>
          <tr><th>Total de unidades (filtro)</th><td class="right">${granUnidades}</td></tr>
          <tr><th>Importe total (filtro)</th><td class="right">${fmtMx(granTotal)}</td></tr>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h3>Por m√©todo de pago (sin filtro)</h3>
      <table>
        <thead><tr><th>M√©todo</th><th class="right">Unidades</th><th class="right">Importe</th></tr></thead>
        <tbody>
          <tr><td>Efectivo</td><td class="right">${totEfe.u}</td><td class="right">${fmtMx(totEfe.$)}</td></tr>
          <tr><td>Tarjeta</td><td class="right">${totTarj.u}</td><td class="right">${fmtMx(totTarj.$)}</td></tr>
        </tbody>
        <tfoot><tr><th>Total d√≠a</th><th class="right">${totTodos.u}</th><th class="right">${fmtMx(totTodos.$)}</th></tr></tfoot>
      </table>
    </div>`;
}

// ---------- UI ----------
document.getElementById('fecha').valueAsDate = new Date();
document.getElementById('cargar').onclick = ()=>{
  const f = document.getElementById('fecha').value;
  if(!f) return alert("Selecciona una fecha");
  loadForDate(f);
};
document.getElementById('imprimir').onclick = ()=>window.print();

// Filtro m√©todo de pago
document.getElementById('payTodos').onclick = ()=>setMetodo('todos');
document.getElementById('payEfe').onclick   = ()=>setMetodo('efectivo');
document.getElementById('payTarj').onclick  = ()=>setMetodo('tarjeta');

// Carga inicial con hoy
loadForDate(document.getElementById('fecha').value = (new Date()).toISOString().slice(0,10));
</script> <!-- ‚úÖ cerramos el script principal -->

<!-- Bot√≥n universal "Volver al men√∫" -->
<script src="back-button.js?v=1" defer></script>

</body>
</html>