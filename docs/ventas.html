<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ventas por día</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;max-width:1000px}
  h1{margin:0 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
  label{display:block;margin:12px 0 6px}
  input,button{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:8px}
  button.primary{background:#111;color:#fff;border-color:#111}
  .muted{color:#666;font-size:12px}
  .section{margin-top:20px}
  .sec-title{font-size:18px;margin:10px 0}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #ddd;padding:6px;text-align:left}
  th{background:#f7f7f7}
  .right{text-align:right}
  .tot{background:#fafafa;font-weight:600}
  .inline{display:inline-block;margin-right:8px}
  .warn{background:#fff3cd;border:1px solid #ffeeba;border-radius:8px;padding:8px}
  @media print{
    .no-print{display:none}
    body{margin:0.5cm}
  }
</style>
</head>
<body>
<h1>Ventas por día</h1>
<p class="muted">Elige una fecha para ver el detalle. Se agrupa por secciones (categorías) y se separa por método de pago.</p>

<div class="row no-print">
  <div>
    <label for="fecha">Fecha</label>
    <input id="fecha" type="date">
  </div>
  <div>
    <button id="cargar" class="primary">Cargar</button>
  </div>
  <div>
    <button id="imprimir">Imprimir</button>
  </div>
</div>

<div id="msg" class="muted"></div>

<div id="resumen" class="section"></div>
<div id="contenedor"></div>

<script>
// ---------- Config del repo ----------
const ORG  = "OswaldoCasillas";
const REPO = "Ventas";

// ---------- Categorías (mismo mapping que en register/produccion) ----------
const CAT_LABELS = {
  "PALETA-AGUA": "Paleta de Agua",
  "PALETA-AGUA-PREMIUM": "Paleta Agua Premium",
  "PALETA-CREMA": "Paleta de Crema",
  "PALETA-CREMA-PREMIUM": "Paleta Crema Premium",
  "PALETA-SIN-AZUCAR": "Paleta Sin Azúcar/Keto",
  "PALETA-MINI": "Paleta Mini",
  "HELADO-NIEVE": "Helado Nieve",
  "HELADO-CLASICO": "Helado Clásico",
  "HELADO-GOURMET": "Helado Gourmet",
  "HELADO-SIN-AZUCAR": "Helado Sin Azúcar",
  "MALTEADA": "Malteada",
  "AGUA-FRESCA": "Aguas Frescas",
  "BEBIDA": "Bebidas",
  "POSTRE": "Postres",
  "BOTANA": "Botanas",
  "EXTRA": "Extras"
};
const SECTION_ORDER = [
  "PALETA-AGUA","PALETA-AGUA-PREMIUM","PALETA-CREMA","PALETA-CREMA-PREMIUM","PALETA-SIN-AZUCAR","PALETA-MINI",
  "HELADO-NIEVE","HELADO-CLASICO","HELADO-GOURMET","HELADO-SIN-AZUCAR",
  "MALTEADA","AGUA-FRESCA","BEBIDA","POSTRE","BOTANA","EXTRA","OTROS"
];

function getCategoryOf(sku){
  const keys = Object.keys(CAT_LABELS).sort((a,b)=>b.length-a.length);
  for(const k of keys){ if(sku.startsWith(k)) return k; }
  return "OTROS";
}
function skuToNice(sku){
  const prefixes = [
    "PALETA-AGUA-PREMIUM","PALETA-CREMA-PREMIUM","PALETA-SIN-AZUCAR",
    "PALETA-AGUA","PALETA-CREMA","PALETA-MINI",
    "HELADO-NIEVE","HELADO-CLASICO","HELADO-GOURMET","HELADO-SIN-AZUCAR",
    "AGUA-FRESCA","MALTEADA","BEBIDA","POSTRE","BOTANA","EXTRA"
  ];
  let name = sku;
  for(const p of prefixes){
    if(name.startsWith(p+"-")) { name = name.slice(p.length+1); break; }
  }
  name = name.replace(/-/g," ").toLowerCase()
             .replace(/\b\w/g, c=>c.toUpperCase())
             .replace(/\bS\/?Azucar\b/gi,'Sin Azúcar');
  return name.trim();
}
function fmtMx(n){ return Number(n||0).toLocaleString('es-MX',{style:'currency',currency:'MXN'}); }

// ---------- CSV parser pequeñito ----------
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(",").map(h=>h.trim());
  return lines.map(line=>{
    const parts = [];
    let current = "", inQuotes = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"' ){ inQuotes = !inQuotes; continue; }
      if(ch === "," && !inQuotes){ parts.push(current); current=""; continue; }
      current += ch;
    }
    parts.push(current);
    const obj = {};
    headers.forEach((h,i)=>obj[h]= (parts[i]||"").trim());
    return obj;
  });
}

// ---------- Carga datos para una fecha ----------
async function loadForDate(fecha){
  const msg = document.getElementById('msg');
  msg.textContent = "Cargando…";
  // Preferimos el archivo diario si existe
  const dailyUrl = `diario/${fecha}-ventas.csv?_=${Date.now()}`;
  let rows = null;
  try{
    const r = await fetch(dailyUrl);
    if(r.ok){
      rows = parseCSV(await r.text());
    }
  }catch(e){/* ignora */}
  if(!rows){
    // Fallback: ventas_detalle.csv y filtramos por fecha
    const r2 = await fetch(`ventas_detalle.csv?_=${Date.now()}`);
    if(!r2.ok){
      msg.innerHTML = `<div class="warn">No encontré ventas para esa fecha ni el detalle general. ¿Ya corrió el workflow después de registrar ventas?</div>`;
      render([], fecha);
      return;
    }
    const all = parseCSV(await r2.text());
    rows = all.filter(x=>x.fecha===fecha);
  }
  render(rows, fecha);
  msg.textContent = "";
}

// ---------- Render con Efectivo/Tarjeta ----------
function render(rows, fecha){
  const cont = document.getElementById('contenedor');
  const res  = document.getElementById('resumen');
  cont.innerHTML = ""; res.innerHTML = "";

  if(!rows || rows.length===0){
    cont.innerHTML = `<div class="warn">No hay ventas registradas el ${fecha}.</div>`;
    return;
  }

  // Normaliza numéricos + método de pago
  rows.forEach(r=>{
    r.cantidad = Number(r.cantidad||0);
    r.precio_unit = Number(r.precio_unit||0);
    r.importe = Number(r.importe|| (r.cantidad*r.precio_unit));
    // metodo_pago si existe, si no, inferimos por texto
    if (!r.metodo_pago){
      const t = `${r.issue||""} ${r.descripcion||""} ${r.title||""}`; // por si vienen del parser
      r.metodo_pago = /\(TARJETA\)|\[\s*TARJETA\s*\]|Método de pago.*Tarjeta/i.test(t) ? "tarjeta" : "efectivo";
    }
  });

  // Resumen por método
  const ef = rows.filter(r=>r.metodo_pago==="efectivo");
  const tj = rows.filter(r=>r.metodo_pago==="tarjeta");
  const totUds = rows.reduce((s,r)=>s+r.cantidad,0);
  const totImp = rows.reduce((s,r)=>s+r.importe,0);
  const efUds  = ef.reduce((s,r)=>s+r.cantidad,0);
  const efImp  = ef.reduce((s,r)=>s+r.importe,0);
  const tjUds  = tj.reduce((s,r)=>s+r.cantidad,0);
  const tjImp  = tj.reduce((s,r)=>s+r.importe,0);

  // Agrupa por sección -> (item, método)
  const bySec = {};
  for(const r of rows){
    const sec = getCategoryOf(r.item);
    if(!bySec[sec]) bySec[sec] = {};
    const key = r.item + "|" + (r.metodo_pago||"efectivo");
    if(!bySec[sec][key]) bySec[sec][key] = {
      sku:r.item,
      nombre: r.descripcion || skuToNice(r.item),
      metodo: r.metodo_pago || "efectivo",
      cantidad:0, importe:0, precio:r.precio_unit
    };
    bySec[sec][key].cantidad += r.cantidad;
    bySec[sec][key].importe  += r.importe;
    if(!bySec[sec][key].precio && r.precio_unit) bySec[sec][key].precio = r.precio_unit;
  }

  // Render secciones (se separa por método en la fila)
  const sections = Object.keys(bySec).sort((a,b)=>SECTION_ORDER.indexOf(a)-SECTION_ORDER.indexOf(b));
  for(const sec of sections){
    const items = Object.values(bySec[sec]).sort((a,b)=>b.cantidad-a.cantidad || a.nombre.localeCompare(b.nombre,'es'));
    const totalSec = items.reduce((s,x)=>s+x.importe,0);
    const udsSec   = items.reduce((s,x)=>s+x.cantidad,0);

    const html = `
      <div class="section">
        <div class="sec-title">${CAT_LABELS[sec]||sec} —
          <span class="muted">${udsSec} u • ${fmtMx(totalSec)}</span>
        </div>
        <table>
          <thead><tr>
            <th>Producto</th><th>SKU</th><th class="right">Cantidad</th>
            <th class="right">Precio</th><th class="right">Importe</th><th>Método</th>
          </tr></thead>
          <tbody>
            ${items.map(x=>`<tr>
              <td>${x.nombre}</td>
              <td>${x.sku}</td>
              <td class="right">${x.cantidad}</td>
              <td class="right">${x.precio?fmtMx(x.precio):""}</td>
              <td class="right">${fmtMx(x.importe)}</td>
              <td>${x.metodo==="tarjeta"?"Tarjeta":"Efectivo"}</td>
            </tr>`).join("")}
          </tbody>
          <tfoot><tr><th colspan="4" class="right tot">Total sección</th><th class="right tot">${fmtMx(totalSec)}</th><th></th></tr></tfoot>
        </table>
      </div>`;
    cont.insertAdjacentHTML('beforeend', html);
  }

  res.innerHTML = `
    <div class="section">
      <h2>Resumen del día ${fecha}</h2>
      <table>
        <tbody>
          <tr><th>Total de unidades</th><td class="right">${totUds}</td></tr>
          <tr><th>Importe total</th><td class="right">${fmtMx(totImp)}</td></tr>
          <tr><th>Unidades (Efectivo)</th><td class="right">${efUds}</td></tr>
          <tr><th>Importe (Efectivo)</th><td class="right">${fmtMx(efImp)}</td></tr>
          <tr><th>Unidades (Tarjeta)</th><td class="right">${tjUds}</td></tr>
          <tr><th>Importe (Tarjeta)</th><td class="right">${fmtMx(tjImp)}</td></tr>
        </tbody>
      </table>
    </div>`;
}

// ---------- UI ----------
document.getElementById('fecha').valueAsDate = new Date();
document.getElementById('cargar').onclick = ()=>{
  const f = document.getElementById('fecha').value;
  if(!f) return alert("Selecciona una fecha");
  loadForDate(f);
};
document.getElementById('imprimir').onclick = ()=>window.print();

// Carga inicial con hoy
loadForDate(document.getElementById('fecha').value = (new Date()).toISOString().slice(0,10));
</script> <!-- ✅ cerramos el script principal -->

<!-- Botón universal "Volver al menú" -->
<script src="back-button.js?v=1" defer></script>

</body>
</html>
