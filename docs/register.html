<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Registrar venta</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;max-width:900px}
  h1{font-size:40px;margin:0 0 12px}
  label{display:block;margin:12px 0 6px}
  input,select,button{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:8px}
  select,input{width:100%}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>div{flex:1 1 240px}
  .cats{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .cat{border:1px solid #ccc;border-radius:999px;padding:6px 12px;background:#f5f5f5;cursor:pointer}
  .cat.active{outline:2px solid #000;background:#fff}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border:1px solid #ddd;padding:6px;text-align:left}
  th{background:#f7f7f7}
  .right{text-align:right}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .primary{background:#111;color:#fff;border-color:#111}
  .danger{background:#c62828;color:#fff;border-color:#c62828}
  .muted{color:#666;font-size:12px}
  .qty-wrap{display:flex;gap:6px;align-items:center}
  .qty-btn{width:48px;min-width:48px;padding:10px;border-radius:10px}

  /* ====== Bot√≥n volver al men√∫ ====== */
  .topbar{display:flex;justify-content:flex-start;margin-bottom:12px}
  .btn-link{border:1px solid #ccc;border-radius:8px;padding:8px 12px;text-decoration:none;color:inherit;display:inline-block}
  .btn-link:hover{background:#f5f5f5}
  @media print{.no-print{display:none}}
</style>
</head>
<body>

<!-- Barra superior con bot√≥n de regreso -->
<div class="topbar no-print">
  <a class="btn-link" href="./index.html">‚Üê Men√∫ principal</a>
</div>

<h1>Registrar venta</h1>
<p class="muted">Selecciona productos por categor√≠a, agr√©galos al carrito y confirma. Si configuraste un backend, se registrar√° sin salir de la p√°gina.</p>

<label>Fecha</label>
<input id="fecha" type="date">

<label>Categor√≠a</label>
<div class="cats" id="cats"></div>

<label>Producto</label>
<select id="item"></select>

<div class="row">
  <div>
    <label>Cantidad</label>
    <div class="qty-wrap">
      <button type="button" class="qty-btn" id="qtyMinus">‚àí</button>
      <input id="cantidad" type="number" min="1" value="1" inputmode="numeric">
      <button type="button" class="qty-btn" id="qtyPlus">+</button>
    </div>
  </div>
  <div>
    <label>Precio unitario (opcional)</label>
    <input id="precio" type="number" step="0.01" placeholder="0.00" inputmode="decimal">
  </div>
</div>

<div class="actions">
  <button id="add">Agregar al carrito</button>
  <button id="clear" class="danger">Vaciar carrito</button>
</div>

<h3>Carrito</h3>
<table id="cartTbl">
  <thead><tr><th>SKU</th><th>Descripci√≥n</th><th class="right">Cantidad</th><th class="right">Precio</th><th class="right">Importe</th><th></th></tr></thead>
  <tbody></tbody>
  <tfoot><tr><th colspan="4" class="right">Total</th><th class="right" id="totalCell">$0.00</th><th></th></tr></tfoot>
</table>

<label>Notas (opcional)</label>
<input id="notas" type="text" placeholder="Cliente, canal, etc.">

<div class="actions">
  <button id="confirm" class="primary">Confirmar venta</button>
</div>

<p class="muted">QR r√°pido por producto: <a id="qr-link" href="#">crear</a></p>

<script>
  // ========= CONFIG =========
  const ORG  = "OswaldoCasillas";
  const REPO = "Ventas";

  // üëâ SOLO una definici√≥n:
  // Pon aqu√≠ tu endpoint en Vercel (o d√©jalo vac√≠o para usar el plan B que abre un issue):
  const API_URL = "https://ventas-backend-rose.vercel.app/api/create-issue";

  // D√≥nde est√° el men√∫:
  const MENU_LOCAL    = "menu.json"; // si subiste menu.json al mismo host
  const MENU_FALLBACK = `https://${ORG.toLowerCase()}.github.io/${REPO}/menu.json`;

  // ========= CATEGOR√çAS =========
  const CAT_LABELS = {
    "PALETA-AGUA": "Paleta de Agua",
    "PALETA-AGUA-PREMIUM": "Paleta Agua Premium",
    "PALETA-CREMA": "Paleta de Crema",
    "PALETA-CREMA-PREMIUM": "Paleta Crema Premium",
    "PALETA-SIN-AZUCAR": "Paleta Sin Az√∫car/Keto",
    "PALETA-ALCOHOL": "Paleta con Alcohol",          // ‚úÖ NUEVA
    "PALETA-MINI": "Paleta Mini",
    "HELADO-NIEVE": "Helado Nieve",
    "HELADO-CLASICO": "Helado Cl√°sico",
    "HELADO-GOURMET": "Helado Gourmet",
    "HELADO-SIN-AZUCAR": "Helado Sin Az√∫car",
    "MALTEADA": "Malteada",
    "AGUA-FRESCA": "Aguas Frescas",
    "BEBIDA": "Bebidas",
    "POSTRE": "Postres",
    "BOTANA": "Botanas",
    "EXTRA": "Extras"
  };

  // ========= ESTADO =========
  let MENU = []; let FILTER = null; const cart = [];
  document.getElementById('fecha').valueAsDate = new Date();
  function fmt(n){ return (n==null||n==='') ? '' : Number(n).toLocaleString('es-MX',{style:'currency',currency:'MXN'}); }

  // ========= HELPERS NOMBRES =========
  function getCategoryOf(sku){const ks=Object.keys(CAT_LABELS).sort((a,b)=>b.length-a.length);for(const k of ks){if(sku.startsWith(k))return k}return"OTROS"}
  function skuToNice(s){const pref=["PALETA-AGUA-PREMIUM","PALETA-CREMA-PREMIUM","PALETA-SIN-AZUCAR","PALETA-AGUA","PALETA-CREMA","PALETA-MINI","HELADO-NIEVE","HELADO-CLASICO","HELADO-GOURMET","HELADO-SIN-AZUCAR","AGUA-FRESCA","MALTEADA","BEBIDA","POSTRE","BOTANA","EXTRA"];let n=s;for(const p of pref){if(n.startsWith(p+"-")){n=n.slice(p.length+1);break}}return n.replace(/-/g," ").toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()).replace(/\bS\/?Azucar\b/gi,'Sin Az√∫car')}
  function niceLabel(p){const base=(p.descripcion&&p.descripcion.trim())?p.descripcion:skuToNice(p.item);const cat=CAT_LABELS[getCategoryOf(p.item)]||"";const price=(p.precio!==undefined&&p.precio!=="")?` ($${p.precio})`:"";return `${base}${price}${cat?` ‚Äî ${cat}`:''}`}

  // ========= MEN√ö (con fallback) =========
  async function fetchJSON(url){
    const r = await fetch(url + "?_=" + Date.now(), { cache: "no-store" });
    if (!r.ok) throw new Error(`${r.status} ${url}`);
    return r.json();
  }
  async function loadMenu(){
    try {
      MENU = await fetchJSON(MENU_LOCAL);
    } catch(e1){
      console.warn("menu.json local no disponible, usando fallback‚Ä¶", e1);
      try { MENU = await fetchJSON(MENU_FALLBACK); }
      catch(e2){
        console.error("No se pudo cargar el cat√°logo.", e2);
        alert("No pude cargar el cat√°logo (menu.json).\nIntent√©:\n‚Ä¢ " + location.origin + "/" + MENU_LOCAL + "\n‚Ä¢ " + MENU_FALLBACK);
        return;
      }
    }
    buildCategories(); renderOptions();
    const q = new URLSearchParams(location.search);
    if (q.get('item')) {
      const sku = q.get('item'); const sel = document.getElementById('item');
      if ([...sel.options].some(o => o.value === sku)) sel.value = sku;
      setPriceFromSelected();
    }
  }

  function buildCategories(){
    const set = new Set(MENU.map(x=>getCategoryOf(x.item)).filter(k=>k!=="OTROS"));
    const wrap = document.getElementById('cats');
    wrap.innerHTML = `<span class="cat ${FILTER===null?'active':''}" data-k="">Todos</span>` +
      [...set].map(k=>`<span class="cat ${FILTER===k?'active':''}" data-k="${k}">${CAT_LABELS[k]||k}</span>`).join('');
    wrap.querySelectorAll('.cat').forEach(btn=>{
      btn.onclick = ()=>{
        FILTER = btn.dataset.k || null;
        wrap.querySelectorAll('.cat').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderOptions();
        setPriceFromSelected();
      };
    });
  }

  function setPriceFromSelected(){
    const sel = document.getElementById('item');
    if (!sel || !sel.options.length) { document.getElementById('precio').value = ""; return; }
    const p = sel.selectedOptions[0]?.dataset?.precio ?? sel.options[0].dataset.precio;
    document.getElementById('precio').value = p ? Number(p).toFixed(2) : "";
  }

  function renderOptions(){
    const sel = document.getElementById('item');
    const prev = sel.value;
    let items = MENU.slice();
    if (FILTER) items = items.filter(x => getCategoryOf(x.item) === FILTER);
    items.sort((a,b)=>niceLabel(a).localeCompare(niceLabel(b),'es'));
    sel.innerHTML = items.map(x => `<option value="${x.item}" data-precio="${x.precio||''}">${niceLabel(x)}</option>`).join('');
    if ([...sel.options].some(o=>o.value===prev)) sel.value = prev;
    setPriceFromSelected();
    sel.onchange = () => setPriceFromSelected();
  }

  // ========= BOTONES ¬± =========
  function clampQty(){ const inp=document.getElementById('cantidad'); let v=parseInt(inp.value||'1',10); if(isNaN(v)||v<1)v=1; inp.value=v; }
  document.getElementById('qtyMinus').onclick = ()=>{ const inp=document.getElementById('cantidad'); clampQty(); inp.value = Math.max(1, parseInt(inp.value,10)-1); };
  document.getElementById('qtyPlus').onclick  = ()=>{ const inp=document.getElementById('cantidad'); clampQty(); inp.value = parseInt(inp.value,10)+1; };
  document.getElementById('cantidad').addEventListener('input', clampQty);

  // ========= CARRITO =========
  function renderCart(){
    const tb = document.querySelector('#cartTbl tbody');
    tb.innerHTML = cart.map((c,i)=>{
      const imp = (Number(c.precio||0)*Number(c.cantidad||0));
      return `<tr>
        <td>${c.item}</td><td>${c.descripcion||''}</td>
        <td class="right">${c.cantidad}</td>
        <td class="right">${fmt(c.precio)}</td>
        <td class="right">${fmt(imp)}</td>
        <td><button data-i="${i}" class="rm">Quitar</button></td>
      </tr>`;
    }).join('');
    tb.querySelectorAll('.rm').forEach(b=>b.onclick=()=>{ cart.splice(Number(b.dataset.i),1); renderCart(); });
    const total = cart.reduce((s,c)=>s+(Number(c.precio||0)*Number(c.cantidad||0)),0);
    document.getElementById('totalCell').textContent = fmt(total);
  }

  document.getElementById('add').onclick = ()=>{
    const sel = document.getElementById('item');
    const sku = sel.value;
    const cantidad = parseInt(document.getElementById('cantidad').value||'1',10);
    if(!sku || cantidad<=0) return alert("Selecciona producto y cantidad v√°lida");
    const prod = MENU.find(x=>x.item===sku) || {descripcion:'',precio:''};
    const precio = document.getElementById('precio').value || prod.precio || '';
    const idx = cart.findIndex(c=>c.item===sku && String(c.precio||'')===String(precio||''));
    if(idx>=0) cart[idx].cantidad += cantidad;
    else cart.push({item:sku, descripcion:niceLabel(prod).split(' ‚Äî ')[0], cantidad, precio});
    renderCart();
    document.getElementById('cantidad').value = 1;
    setPriceFromSelected();
  };

  document.getElementById('clear').onclick = ()=>{ cart.splice(0,cart.length); renderCart(); };

  document.getElementById('qr-link').onclick = (e)=>{
    e.preventDefault();
    const item = document.getElementById('item').value;
    const u = new URL(location.href); u.searchParams.set('item', item);
    prompt("Copia este enlace y convi√©rtelo en QR:", u.toString());
  };

  // ========= ENVIAR =========
  function buildIssueUrlFallback(){
    const fecha = document.getElementById('fecha').value;
    const notas = document.getElementById('notas').value;
    const base = `https://github.com/${ORG}/${REPO}/issues/new`;
    const title = `Venta: ${cart.length} items @ ${fecha}`;
    let body = `**Fecha**: ${fecha}\n**Notas**: ${notas||''}\n\n**Items**\nSKU | Cantidad | Precio\n`;
    cart.forEach(c=>{ body += `${c.item} | ${c.cantidad} | ${c.precio||''}\n`; });
    const params = new URLSearchParams({ /*template:'sale.md',*/ title, body, labels: "venta" });
    return `${base}?${params.toString()}`;
  }

  async function crearVentaViaAPI(){
    const fecha = document.getElementById('fecha').value;
    const notas = document.getElementById('notas').value;
    if(!fecha){ alert("Falta la fecha"); return; }
    if(cart.length===0){ alert("Agrega al menos un producto"); return; }

    if (!API_URL) { location.href = buildIssueUrlFallback(); return; }

    try{
      const items = cart.map(c => ({ item: c.item, cantidad: c.cantidad, precio: c.precio || "" }));
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ type: "venta", fecha, notas, items })
      });
      if(!resp.ok){
        let errText = "";
        try{ const err = await resp.json(); errText = err.error || JSON.stringify(err); }catch(_){}
        alert("Error creando la venta: " + (errText || resp.statusText));
        return;
      }
      const data = await resp.json().catch(()=>({}));
      alert(`Venta registrada ‚úÖ${data.number?` (issue #${data.number})`:''}`);
      cart.splice(0, cart.length); renderCart();
    }catch(e){
      alert("No se pudo contactar el backend. Verifica API_URL o usa el plan B (issue directo).");
    }
  }
  document.getElementById('confirm').onclick = crearVentaViaAPI;

  // ========= INICIO =========
  document.addEventListener("DOMContentLoaded", loadMenu);
</script>
</body>
</html>
