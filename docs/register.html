<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Registrar venta</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;max-width:900px}
  h1{font-size:40px;margin:0 0 12px}
  label{display:block;margin:12px 0 6px}
  input,select,button{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:8px}
  select,input{width:100%}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>div{flex:1 1 240px}
  .cats{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .cat{border:1px solid #ccc;border-radius:999px;padding:6px 12px;background:#f5f5f5;cursor:pointer}
  .cat.active{outline:2px solid #000;background:#fff}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border:1px solid #ddd;padding:6px;text-align:left}
  th{background:#f7f7f7}
  .right{text-align:right}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .primary{background:#111;color:#fff;border-color:#111}
  .danger{background:#c62828;color:#fff;border-color:#c62828}
  .muted{color:#666;font-size:12px}
</style>
</head>
<body>
<h1>Registrar venta</h1>
<p class="muted">Selecciona productos por categoría, agrégalos al carrito y confirma. Si configuraste un backend, se registrará sin salir de la página.</p>

<label>Fecha</label>
<input id="fecha" type="date">

<label>Categoría</label>
<div class="cats" id="cats"></div>

<label>Producto</label>
<select id="item"></select>

<div class="row">
  <div>
    <label>Cantidad</label>
    <input id="cantidad" type="number" min="1" value="1">
  </div>
  <div>
    <label>Precio unitario (opcional)</label>
    <input id="precio" type="number" step="0.01" placeholder="0.00">
  </div>
</div>

<div class="actions">
  <button id="add">Agregar al carrito</button>
  <button id="clear" class="danger">Vaciar carrito</button>
</div>

<h3>Carrito</h3>
<table id="cartTbl">
  <thead><tr><th>SKU</th><th>Descripción</th><th class="right">Cantidad</th><th class="right">Precio</th><th class="right">Importe</th><th></th></tr></thead>
  <tbody></tbody>
  <tfoot><tr><th colspan="4" class="right">Total</th><th class="right" id="totalCell">$0.00</th><th></th></tr></tfoot>
</table>

<label>Notas (opcional)</label>
<input id="notas" type="text" placeholder="Cliente, canal, etc.">

<div class="actions">
  <button id="confirm" class="primary">Confirmar venta</button>
</div>

<p class="muted">QR rápido por producto: <a id="qr-link" href="#">crear</a></p>

<script>
  // ====== CONFIG ======
  // Si montaste backend (Vercel/Worker), pon aquí su URL:
  const API_URL = ""; // ej: "https://tu-proyecto.vercel.app/api/create-issue"
  const ORG  = "OswaldoCasillas";  // (solo se usa si dejas el plan B de abrir issue manual)
  const REPO = "Ventas";

  // ====== CATEGORÍAS ======
  const CAT_LABELS = {
    "PALETA-AGUA": "Paleta de Agua",
    "PALETA-AGUA-PREMIUM": "Paleta Agua Premium",
    "PALETA-CREMA": "Paleta de Crema",
    "PALETA-CREMA-PREMIUM": "Paleta Crema Premium",
    "PALETA-SIN-AZUCAR": "Paleta Sin Azúcar/Keto",
    "PALETA-MINI": "Paleta Mini",
    "HELADO-NIEVE": "Helado Nieve",
    "HELADO-CLASICO": "Helado Clásico",
    "HELADO-GOURMET": "Helado Gourmet",
    "HELADO-SIN-AZUCAR": "Helado Sin Azúcar",
    "MALTEADA": "Malteada",
    "AGUA-FRESCA": "Aguas Frescas",
    "BEBIDA": "Bebidas",
    "POSTRE": "Postres",
    "BOTANA": "Botanas",
    "EXTRA": "Extras"
  };

  // ====== ESTADO ======
  let MENU = [];     // {product_id,item,descripcion,precio}
  let FILTER = null; // prefijo de categoría activo
  const cart = [];   // {item, descripcion, cantidad, precio}

  document.getElementById('fecha').valueAsDate = new Date();
  function fmt(n){ return (n==null||n==='') ? '' : Number(n).toLocaleString('es-MX',{style:'currency',currency:'MXN'}); }

  // ====== HELPERS NOMBRES BONITOS ======
  function getCategoryOf(sku){
    const keys = Object.keys(CAT_LABELS).sort((a,b)=>b.length-a.length);
    for(const k of keys){ if(sku.startsWith(k)) return k; }
    return "OTROS";
  }
  function skuToNice(sku){
    const prefixes = [
      "PALETA-AGUA-PREMIUM","PALETA-CREMA-PREMIUM","PALETA-SIN-AZUCAR",
      "PALETA-AGUA","PALETA-CREMA","PALETA-MINI",
      "HELADO-NIEVE","HELADO-CLASICO","HELADO-GOURMET","HELADO-SIN-AZUCAR",
      "AGUA-FRESCA","MALTEADA","BEBIDA","POSTRE","BOTANA","EXTRA"
    ];
    let name = sku;
    for(const p of prefixes){
      if(name.startsWith(p+"-")) { name = name.slice(p.length+1); break; }
    }
    name = name.replace(/-/g," ").toLowerCase()
               .replace(/\b\w/g, c=>c.toUpperCase())
               .replace(/\bS\/?Azucar\b/gi,'Sin Azúcar');
    return name.trim();
  }
  function niceLabel(prod){
    const base = (prod.descripcion && prod.descripcion.trim()) ? prod.descripcion : skuToNice(prod.item);
    const cat  = CAT_LABELS[getCategoryOf(prod.item)] || "";
    const price = (prod.precio!==undefined && prod.precio!=="") ? ` ($${prod.precio})` : "";
    return `${base}${price}${cat?` — ${cat}`:''}`;
  }

  // ====== MENU ======
  async function loadMenu(){
    const r = await fetch('menu.json?_='+Date.now());
    if(!r.ok){ alert("No encuentro el menú (menu.json). Ve a GitHub → Actions → 'Inventory Bot' → Run workflow para generarlo desde data/inventory.csv."); return; }
    MENU = await r.json();
    buildCategories();
    renderOptions();

    // Si viene ?item= preselecciona y **SIEMPRE** fija su precio
    const q = new URLSearchParams(location.search);
    if (q.get('item')) {
      const sku = q.get('item');
      const sel = document.getElementById('item');
      if ([...sel.options].some(o => o.value === sku)) sel.value = sku;
      setPriceFromSelected(); // <-- siempre sobreescribe
    }
  }

  function buildCategories(){
    const set = new Set(MENU.map(x=>getCategoryOf(x.item)).filter(k=>k!=="OTROS"));
    const wrap = document.getElementById('cats');
    wrap.innerHTML = `<span class="cat ${FILTER===null?'active':''}" data-k="">Todos</span>` +
      [...set].map(k=>`<span class="cat ${FILTER===k?'active':''}" data-k="${k}">${CAT_LABELS[k]||k}</span>`).join('');
    wrap.querySelectorAll('.cat').forEach(btn=>{
      btn.onclick = ()=>{
        FILTER = btn.dataset.k || null;
        wrap.querySelectorAll('.cat').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderOptions();      // repobla opciones
        setPriceFromSelected(); // y actualiza precio del primero/seleccionado
      };
    });
  }

  // Setea SIEMPRE el precio del <select> actual
  function setPriceFromSelected(){
    const sel = document.getElementById('item');
    if (!sel || !sel.options.length) { document.getElementById('precio').value = ""; return; }
    const p = sel.selectedOptions[0]?.dataset?.precio ?? sel.options[0].dataset.precio;
    document.getElementById('precio').value = p ? Number(p).toFixed(2) : "";
  }

  function renderOptions(){
    const sel = document.getElementById('item');
    const prev = sel.value; // intenta conservar selección anterior
    let items = MENU.slice();
    if (FILTER) items = items.filter(x => getCategoryOf(x.item) === FILTER);
    items.sort((a,b)=>niceLabel(a).localeCompare(niceLabel(b),'es'));

    sel.innerHTML = items.map(x =>
      `<option value="${x.item}" data-precio="${x.precio||''}">${niceLabel(x)}</option>`
    ).join('');

    // restaura selección si todavía existe, si no queda el primero
    if ([...sel.options].some(o=>o.value===prev)) sel.value = prev;

    // SIEMPRE actualiza precio al renderizar
    setPriceFromSelected();

    // y SIEMPRE al cambiar de producto
    sel.onchange = () => setPriceFromSelected();
  }

  // ====== CARRITO ======
  function renderCart(){
    const tb = document.querySelector('#cartTbl tbody');
    tb.innerHTML = cart.map((c,i)=>{
      const imp = (Number(c.precio||0)*Number(c.cantidad||0));
      return `<tr>
        <td>${c.item}</td><td>${c.descripcion||''}</td>
        <td class="right">${c.cantidad}</td>
        <td class="right">${fmt(c.precio)}</td>
        <td class="right">${fmt(imp)}</td>
        <td><button data-i="${i}" class="rm">Quitar</button></td>
      </tr>`;
    }).join('');
    tb.querySelectorAll('.rm').forEach(b=>b.onclick=()=>{ cart.splice(Number(b.dataset.i),1); renderCart(); });
    const total = cart.reduce((s,c)=>s+(Number(c.precio||0)*Number(c.cantidad||0)),0);
    document.getElementById('totalCell').textContent = fmt(total);
  }

  document.getElementById('add').onclick = ()=>{
    const sel = document.getElementById('item');
    const sku = sel.value;
    const cantidad = Number(document.getElementById('cantidad').value||1);
    if(!sku || cantidad<=0) return alert("Selecciona producto y cantidad válida");

    const prod = MENU.find(x=>x.item===sku) || {descripcion:'',precio:''};
    const precio = document.getElementById('precio').value || prod.precio || '';
    const idx = cart.findIndex(c=>c.item===sku && String(c.precio||'')===String(precio||''));
    if(idx>=0) cart[idx].cantidad += cantidad;
    else cart.push({item:sku, descripcion:niceLabel(prod).split(' — ')[0], cantidad, precio});
    renderCart();

    // Limpia cantidad y re-aplica el precio del ítem seleccionado
    document.getElementById('cantidad').value = 1;
    setPriceFromSelected();
  };

  document.getElementById('clear').onclick = ()=>{ cart.splice(0,cart.length); renderCart(); };

  document.getElementById('qr-link').onclick = (e)=>{
    e.preventDefault();
    const item = document.getElementById('item').value;
    const u = new URL(location.href); u.searchParams.set('item', item);
    prompt("Copia este enlace y conviértelo en QR:", u.toString());
  };

  // ====== ENVIAR ======
  function buildIssueUrlFallback(){
    // plan B: abrir issue en GitHub si no hay API_URL
    const fecha = document.getElementById('fecha').value;
    const notas = document.getElementById('notas').value;
    const base = `https://github.com/${ORG}/${REPO}/issues/new`;
    const title = `Venta: ${cart.length} items @ ${fecha}`;
    let body = `**Fecha**: ${fecha}\n**Notas**: ${notas||''}\n\n**Items**\nSKU | Cantidad | Precio\n`;
    cart.forEach(c=>{ body += `${c.item} | ${c.cantidad} | ${c.precio||''}\n`; });
    const params = new URLSearchParams({ template:'sale.md', title, body });
    return `${base}?${params.toString()}`;
  }

  async function crearVentaViaAPI(){
    const fecha = document.getElementById('fecha').value;
    const notas = document.getElementById('notas').value;
    if(!fecha){ alert("Falta la fecha"); return; }
    if(cart.length===0){ alert("Agrega al menos un producto"); return; }

    if (!API_URL) {
      // Sin backend: abre Issue en GitHub
      location.href = buildIssueUrlFallback();
      return;
    }

    try{
      const items = cart.map(c => ({ item: c.item, cantidad: c.cantidad, precio: c.precio || "" }));
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ type: "venta", fecha, notas, items })
      });
      if(!resp.ok){
        const err = await resp.json().catch(()=>({}));
        alert("Error creando la venta: " + (err.error || resp.statusText));
        return;
      }
      const data = await resp.json();
      alert(`Venta registrada ✅\nIssue #${data.number}`);
      cart.splice(0, cart.length); renderCart();
    }catch(e){
      alert("No se pudo contactar el backend. Verifica API_URL o usa el plan B (issue directo).");
    }
  }

  document.getElementById('confirm').onclick = ()=>{ crearVentaViaAPI(); };

  // ====== INICIO ======
  loadMenu();
</script>
</body>
</html>