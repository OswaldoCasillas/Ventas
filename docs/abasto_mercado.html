<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Abasto Mercado</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;max-width:900px}
  h1{font-size:32px;margin:0 0 12px}
  label{display:block;margin:12px 0 6px}
  input,select,button{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:8px}
  select,input{width:100%}
  .cats{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .cat{border:1px solid #ccc;border-radius:999px;padding:6px 12px;background:#f5f5f5;cursor:pointer}
  .cat.active{outline:2px solid #000;background:#fff}
  table{border-collapse:collapse;width:100%;margin-top:12px}
  th,td{border:1px solid #ddd;padding:6px;text-align:left}
  th{background:#f7f7f7}
  .right{text-align:right}
  .primary{background:#111;color:#fff;border-color:#111}
  .danger{background:#c62828;color:#fff;border-color:#c62828}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>div{flex:1 1 220px}
  .qty-wrap{display:flex;gap:6px;align-items:center}
  .qty-btn{width:48px;min-width:48px;padding:10px;border-radius:10px}
  .muted{color:#666;font-size:12px}
</style>
</head>
<body>
<h1>Abasto Mercado (traspaso)</h1>
<p class="muted">Resta del inventario general y suma al inventario de Mercado.</p>

<label>Fecha</label>
<input id="fecha" type="date">

<label>Categoría</label>
<div class="cats" id="cats"></div>

<label>Producto</label>
<select id="item"></select>

<div class="row">
  <div>
    <label>Cantidad</label>
    <div class="qty-wrap">
      <button type="button" class="qty-btn" id="qtyMinus">−</button>
      <input id="cantidad" type="number" min="1" value="1" inputmode="numeric">
      <button type="button" class="qty-btn" id="qtyPlus">+</button>
    </div>
  </div>
  <div>
    <label>Notas (opcional)</label>
    <input id="notas" type="text" placeholder="Quién entrega/recibe, etc.">
  </div>
</div>

<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
  <button id="add">Agregar al carrito</button>
  <button id="clear" class="danger">Vaciar carrito</button>
</div>

<h3>Carrito</h3>
<table id="cartTbl">
  <thead><tr><th>SKU</th><th>Descripción</th><th class="right">Cantidad</th><th></th></tr></thead>
  <tbody></tbody>
</table>

<div style="margin-top:12px">
  <button id="confirm" class="primary">Confirmar abasto</button>
</div>

<script>
const ORG="OswaldoCasillas", REPO="Ventas";
const API_URL=""; // si pones backend, úsalo; si no, abre issue prellenado

const CAT_LABELS={ "PALETA-AGUA":"Paleta de Agua","PALETA-AGUA-PREMIUM":"Paleta Agua Premium","PALETA-CREMA":"Paleta de Crema","PALETA-CREMA-PREMIUM":"Paleta Crema Premium","PALETA-SIN-AZUCAR":"Paleta Sin Azúcar/Keto","HELADO-NIEVE":"Helado Nieve","HELADO-CLASICO":"Helado Clásico","HELADO-GOURMET":"Helado Gourmet","HELADO-SIN-AZUCAR":"Helado Sin Azúcar","MALTEADA":"Malteada","AGUA-FRESCA":"Aguas Frescas","BEBIDA":"Bebidas","POSTRE":"Postres","BOTANA":"Botanas","EXTRA":"Extras","PALETA-MINI":"Paleta Mini" };

let MENU=[], FILTER=null, cart=[];
document.getElementById('fecha').valueAsDate=new Date();
function catOf(sku){const ks=Object.keys(CAT_LABELS).sort((a,b)=>b.length-a.length);for(const k of ks){if(sku.startsWith(k))return k}return"OTROS"}
function skuToNice(s){const pref=["PALETA-AGUA-PREMIUM","PALETA-CREMA-PREMIUM","PALETA-SIN-AZUCAR","PALETA-AGUA","PALETA-CREMA","PALETA-MINI","HELADO-NIEVE","HELADO-CLASICO","HELADO-GOURMET","HELADO-SIN-AZUCAR","AGUA-FRESCA","MALTEADA","BEBIDA","POSTRE","BOTANA","EXTRA"];let n=s;for(const p of pref){if(n.startsWith(p+"-")){n=n.slice(p.length+1);break}}return n.replace(/-/g," ").toLowerCase().replace(/\b\w/g,c=>c.toUpperCase())}
function niceLabel(p){const base=(p.descripcion&&p.descripcion.trim())?p.descripcion:skuToNice(p.item);const cat=CAT_LABELS[catOf(p.item)]||"";return `${base}${cat?` — ${cat}`:''}`}

async function loadMenu(){const r=await fetch('menu.json?_='+Date.now());if(!r.ok){alert("No encuentro menu.json");return}MENU=await r.json();buildCats();renderOptions()}
function buildCats(){const set=new Set(MENU.map(x=>catOf(x.item)).filter(k=>k!=="OTROS"));const w=document.getElementById('cats');w.innerHTML=`<span class="cat ${FILTER===null?'active':''}" data-k="">Todos</span>`+[...set].map(k=>`<span class="cat ${FILTER===k?'active':''}" data-k="${k}">${CAT_LABELS[k]||k}</span>`).join('');w.querySelectorAll('.cat').forEach(b=>b.onclick=()=>{FILTER=b.dataset.k||null;w.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));b.classList.add('active');renderOptions()})}
function renderOptions(){const sel=document.getElementById('item');let items=MENU.slice();if(FILTER)items=items.filter(x=>catOf(x.item)===FILTER);items.sort((a,b)=>niceLabel(a).localeCompare(niceLabel(b),'es'));sel.innerHTML=items.map(x=>`<option value="${x.item}">${niceLabel(x)}</option>`).join('')}

function renderCart(){const tb=document.querySelector('#cartTbl tbody');tb.innerHTML=cart.map((c,i)=>`<tr><td>${c.item}</td><td>${c.descripcion||''}</td><td class="right">${c.cantidad}</td><td><button data-i="${i}" class="rm">Quitar</button></td></tr>`).join('');tb.querySelectorAll('.rm').forEach(b=>b.onclick=()=>{cart.splice(Number(b.dataset.i),1);renderCart()})}

function clampQty(){const inp=document.getElementById('cantidad');let v=parseInt(inp.value||'1',10);if(isNaN(v)||v<1)v=1;inp.value=v}
document.getElementById('qtyMinus').onclick=()=>{const i=document.getElementById('cantidad');clampQty();i.value=Math.max(1,parseInt(i.value,10)-1)}
document.getElementById('qtyPlus').onclick=()=>{const i=document.getElementById('cantidad');clampQty();i.value=parseInt(i.value,10)+1}
document.getElementById('cantidad').addEventListener('input',clampQty)

document.getElementById('add').onclick=()=>{const sku=document.getElementById('item').value;const cant=parseInt(document.getElementById('cantidad').value||'1',10);if(!sku||cant<=0)return alert("Selecciona producto y cantidad");const p=MENU.find(x=>x.item===sku)||{descripcion:''};const idx=cart.findIndex(c=>c.item===sku);if(idx>=0)cart[idx].cantidad+=cant;else cart.push({item:sku,descripcion:niceLabel(p),cantidad:cant});renderCart();document.getElementById('cantidad').value=1}

document.getElementById('clear').onclick=()=>{cart.splice(0,cart.length);renderCart()}

function buildIssueUrl(){const fecha=document.getElementById('fecha').value;const notas=document.getElementById('notas').value;const base=`https://github.com/${ORG}/${REPO}/issues/new`;const title=`Abasto Mercado: ${cart.length} items @ ${fecha}`;let body=`**Fecha**: ${fecha}\n**Notas**: ${notas||''}\n\n**Items**\nSKU | Cantidad\n`;cart.forEach(c=>body+=`${c.item} | ${c.cantidad}\n`);const params=new URLSearchParams({title,body,labels:"abasto-mercado"});return `${base}?${params.toString()}`}

async function submit(){if(cart.length===0)return alert("Carrito vacío");if(!document.getElementById('fecha').value)return alert("Falta fecha");if(!API_URL){location.href=buildIssueUrl();return}/* backend opcional */}
document.getElementById('confirm').onclick=submit;

loadMenu();
<script src="back-button.js"></script>
</body>
</html>
